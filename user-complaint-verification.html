<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Quejas del Usuario - ciaociao-recibos</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            min-height: 100vh;
        }
        .verification-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .verification-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .verification-header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 700;
        }
        .complaints-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        .complaint-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #e74c3c;
        }
        .complaint-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 15px 0;
        }
        .complaint-description {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-style: italic;
        }
        .test-result {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        .result-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .result-testing {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d4fc;
        }
        .test-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        .btn-test { background: #3498db; color: white; }
        .btn-fix { background: #e67e22; color: white; }
        .btn-verify { background: #27ae60; color: white; }
        .btn:hover { transform: translateY(-1px); }
        .overall-verification {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .verification-summary {
            grid-column: 1 / -1;
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        .verification-log {
            grid-column: 1 / -1;
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            max-height: 250px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }
    </style>
</head>
<body>
    <div class="verification-container">
        <div class="verification-header">
            <h1>ü©∫ Verificaci√≥n de Quejas del Usuario</h1>
            <p>Validaci√≥n espec√≠fica de los problemas reportados por el usuario</p>
        </div>
        
        <div class="complaints-grid">
            <div class="overall-verification">
                <h2 id="overallStatus">üîÑ Verificando quejas reportadas...</h2>
                <p id="statusDescription">Evaluando cada problema espec√≠fico reportado por el usuario</p>
            </div>
            
            <div class="complaint-card">
                <div class="complaint-title">‚ùå "No hace vista previa"</div>
                <div class="complaint-description">"El sistema no muestra la vista previa de los recibos antes de generar el PDF"</div>
                <div id="preview-result" class="test-result result-testing">üîÑ Verificando funci√≥n showPreview()...</div>
                <div class="test-actions">
                    <button class="btn btn-test" onclick="testPreviewFunction()">üß™ Test Vista Previa</button>
                    <button class="btn btn-verify" onclick="verifyPreviewModal()">üëÄ Verificar Modal</button>
                </div>
            </div>
            
            <div class="complaint-card">
                <div class="complaint-title">‚ùå "No genera comprobantes"</div>
                <div class="complaint-description">"El sistema no puede generar archivos PDF de los recibos"</div>
                <div id="pdf-result" class="test-result result-testing">üîÑ Verificando funci√≥n generatePDF()...</div>
                <div class="test-actions">
                    <button class="btn btn-test" onclick="testPDFGeneration()">üìÑ Test Generar PDF</button>
                    <button class="btn btn-verify" onclick="verifyPDFLibraries()">üìö Verificar Librer√≠as</button>
                </div>
            </div>
            
            <div class="complaint-card">
                <div class="complaint-title">‚ùå "No se pone el n√∫mero de recibo"</div>
                <div class="complaint-description">"Los recibos no muestran numeraci√≥n autom√°tica o se duplican n√∫meros"</div>
                <div id="numbering-result" class="test-result result-testing">üîÑ Verificando numeraci√≥n autom√°tica...</div>
                <div class="test-actions">
                    <button class="btn btn-test" onclick="testReceiptNumbering()">üî¢ Test Numeraci√≥n</button>
                    <button class="btn btn-verify" onclick="verifyCounterLogic()">‚öôÔ∏è Verificar L√≥gica</button>
                </div>
            </div>
            
            <div class="complaint-card">
                <div class="complaint-title">‚ùå "No sirven las firmas"</div>
                <div class="complaint-description">"El sistema de firmas digitales no funciona o no se pueden capturar las firmas"</div>
                <div id="signature-result" class="test-result result-testing">üîÑ Verificando SignaturePad...</div>
                <div class="test-actions">
                    <button class="btn btn-test" onclick="testSignatureSystem()">‚úçÔ∏è Test Firmas</button>
                    <button class="btn btn-verify" onclick="verifySignatureCanvas()">üé® Verificar Canvas</button>
                </div>
            </div>
            
            <div class="verification-summary">
                <h3>üìä Resumen de Verificaci√≥n</h3>
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="resolvedCount">0</div>
                        <div class="stat-label">Resueltos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="partialCount">0</div>
                        <div class="stat-label">Parciales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="failingCount">4</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="successRate">0%</div>
                        <div class="stat-label">Tasa √âxito</div>
                    </div>
                </div>
            </div>
            
            <div class="verification-log" id="verificationLog">
                <div class="log-entry log-info">ü©∫ Sistema de verificaci√≥n de quejas iniciado...</div>
                <div class="log-entry log-info">üìã Evaluando 4 quejas espec√≠ficas del usuario</div>
                <div class="log-entry log-warning">‚ö†Ô∏è Haz clic en los botones de test para verificar cada queja</div>
            </div>
        </div>
        
        <div style="padding: 20px; text-align: center;">
            <button class="btn btn-test" onclick="runAllVerifications()" style="padding: 15px 30px; font-size: 16px;">
                üöÄ Verificar Todas las Quejas
            </button>
            <button class="btn btn-verify" onclick="openReceiptPage()" style="padding: 15px 30px; font-size: 16px;">
                üìÑ Ir a P√°gina de Recibos
            </button>
        </div>
    </div>

    <script>
        let verificationResults = {};
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('verificationLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateResult(complaintId, status, message) {
            const element = document.getElementById(complaintId + '-result');
            let className, icon;
            
            switch(status) {
                case 'pass':
                    className = 'result-pass';
                    icon = '‚úÖ';
                    break;
                case 'fail':
                    className = 'result-fail';
                    icon = '‚ùå';
                    break;
                case 'warning':
                    className = 'result-warning';
                    icon = '‚ö†Ô∏è';
                    break;
                default:
                    className = 'result-testing';
                    icon = 'üîÑ';
            }
            
            element.className = `test-result ${className}`;
            element.textContent = `${icon} ${message}`;
            
            verificationResults[complaintId] = status;
            updateSummaryStats();
        }
        
        function updateSummaryStats() {
            const results = Object.values(verificationResults);
            const resolved = results.filter(r => r === 'pass').length;
            const partial = results.filter(r => r === 'warning').length;
            const failing = results.filter(r => r === 'fail').length;
            const total = results.length || 4; // Default to 4 complaints
            
            document.getElementById('resolvedCount').textContent = resolved;
            document.getElementById('partialCount').textContent = partial;
            document.getElementById('failingCount').textContent = Math.max(0, 4 - resolved - partial);
            
            const successRate = total > 0 ? Math.round(((resolved + partial * 0.5) / 4) * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // Update overall status
            const statusElement = document.getElementById('overallStatus');
            const descElement = document.getElementById('statusDescription');
            
            if (resolved === 4) {
                statusElement.textContent = 'üéâ Todas las quejas han sido resueltas';
                statusElement.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
                descElement.textContent = 'El sistema est√° funcionando correctamente seg√∫n las expectativas del usuario';
            } else if (resolved + partial >= 3) {
                statusElement.textContent = '‚ö†Ô∏è Mayor√≠a de problemas resueltos';
                statusElement.style.background = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
                descElement.textContent = 'Sistema mayormente funcional, algunas optimizaciones pendientes';
            } else if (total === 0) {
                statusElement.textContent = 'üîÑ Verificando quejas reportadas...';
                statusElement.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
                descElement.textContent = 'Evaluando cada problema espec√≠fico reportado por el usuario';
            } else {
                statusElement.textContent = '‚ùå Problemas cr√≠ticos identificados';
                statusElement.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                descElement.textContent = 'Se requieren reparaciones adicionales para resolver las quejas del usuario';
            }
        }
        
        async function testPreviewFunction() {
            log('üîç Verificando funci√≥n de vista previa...', 'info');
            
            try {
                // Test 1: Check if showPreview function exists
                if (typeof window.showPreview === 'function') {
                    updateResult('preview', 'pass', 'Funci√≥n showPreview() disponible y accesible');
                    log('‚úÖ Funci√≥n showPreview encontrada', 'success');
                    
                    // Test 2: Check for preview modal elements
                    if (document.getElementById('previewModal')) {
                        log('‚úÖ Modal de vista previa presente en DOM', 'success');
                    } else {
                        log('‚ö†Ô∏è Modal de vista previa no encontrado (normal en esta p√°gina)', 'warning');
                    }
                    
                } else {
                    updateResult('preview', 'fail', 'Funci√≥n showPreview() no encontrada - PROBLEMA CONFIRMADO');
                    log('‚ùå PROBLEMA CONFIRMADO: showPreview no disponible', 'error');
                }
                
            } catch (error) {
                updateResult('preview', 'fail', `Error verificando vista previa: ${error.message}`);
                log(`‚ùå Error en verificaci√≥n: ${error.message}`, 'error');
            }
        }
        
        async function verifyPreviewModal() {
            log('üëÄ Verificando elementos del modal de vista previa...', 'info');
            
            const requiredElements = [
                'previewModal',
                'receiptPreview', 
                'confirmGeneratePdf',
                'closePreview'
            ];
            
            let foundElements = 0;
            requiredElements.forEach(id => {
                if (document.getElementById(id)) {
                    foundElements++;
                    log(`‚úÖ Elemento ${id} encontrado`, 'success');
                } else {
                    log(`‚ùå Elemento ${id} no encontrado`, 'error');
                }
            });
            
            if (foundElements === requiredElements.length) {
                log('‚úÖ Todos los elementos del modal presentes', 'success');
            } else {
                log(`‚ö†Ô∏è Solo ${foundElements}/${requiredElements.length} elementos encontrados`, 'warning');
            }
        }
        
        async function testPDFGeneration() {
            log('üìÑ Verificando generaci√≥n de PDFs...', 'info');
            
            try {
                // Test 1: Check if generatePDF function exists
                if (typeof window.generatePDF === 'function') {
                    log('‚úÖ Funci√≥n generatePDF encontrada', 'success');
                    
                    // Test 2: Check if jsPDF library is loaded
                    if (typeof window.jsPDF !== 'undefined') {
                        updateResult('pdf', 'pass', 'Generaci√≥n PDF completamente funcional');
                        log('‚úÖ Librer√≠a jsPDF cargada correctamente', 'success');
                    } else {
                        updateResult('pdf', 'warning', 'Funci√≥n presente pero jsPDF no cargado');
                        log('‚ö†Ô∏è jsPDF no disponible - posible problema de CDN', 'warning');
                    }
                    
                } else {
                    updateResult('pdf', 'fail', 'Funci√≥n generatePDF() no encontrada - PROBLEMA CONFIRMADO');
                    log('‚ùå PROBLEMA CONFIRMADO: generatePDF no disponible', 'error');
                }
                
            } catch (error) {
                updateResult('pdf', 'fail', `Error verificando PDF: ${error.message}`);
                log(`‚ùå Error en verificaci√≥n PDF: ${error.message}`, 'error');
            }
        }
        
        async function verifyPDFLibraries() {
            log('üìö Verificando librer√≠as requeridas para PDF...', 'info');
            
            const requiredLibraries = [
                { name: 'jsPDF', check: () => typeof window.jsPDF !== 'undefined' },
                { name: 'html2canvas', check: () => typeof window.html2canvas !== 'undefined' },
                { name: 'CDN Circuit Breaker', check: () => typeof window.cdnCircuitBreaker !== 'undefined' }
            ];
            
            let loadedCount = 0;
            requiredLibraries.forEach(lib => {
                if (lib.check()) {
                    loadedCount++;
                    log(`‚úÖ ${lib.name} disponible`, 'success');
                } else {
                    log(`‚ùå ${lib.name} no cargado`, 'error');
                }
            });
            
            log(`üìä ${loadedCount}/${requiredLibraries.length} librer√≠as cargadas`, loadedCount === requiredLibraries.length ? 'success' : 'warning');
        }
        
        async function testReceiptNumbering() {
            log('üî¢ Verificando numeraci√≥n autom√°tica de recibos...', 'info');
            
            try {
                // Test 1: Check if generateReceiptNumber function exists
                if (typeof window.generateReceiptNumber === 'function') {
                    log('‚úÖ Funci√≥n generateReceiptNumber encontrada', 'success');
                    
                    // Test 2: Check receipt counter in localStorage
                    const counter = localStorage.getItem('receiptCounter');
                    if (counter && !isNaN(parseInt(counter))) {
                        updateResult('numbering', 'pass', `Numeraci√≥n autom√°tica funcional (contador: ${counter})`);
                        log(`‚úÖ Contador de recibos: ${counter}`, 'success');
                    } else {
                        updateResult('numbering', 'warning', 'Funci√≥n presente pero contador no inicializado');
                        log('‚ö†Ô∏è Contador de recibos no encontrado o inv√°lido', 'warning');
                    }
                    
                } else {
                    // Check if we have receipt number input field
                    const receiptInput = document.getElementById('receiptNumber');
                    if (receiptInput) {
                        updateResult('numbering', 'warning', 'Campo presente, funci√≥n no verificable en esta p√°gina');
                        log('‚ö†Ô∏è Campo de n√∫mero presente, funci√≥n no accesible', 'warning');
                    } else {
                        updateResult('numbering', 'fail', 'Sistema de numeraci√≥n no encontrado - PROBLEMA CONFIRMADO');
                        log('‚ùå PROBLEMA CONFIRMADO: numeraci√≥n no disponible', 'error');
                    }
                }
                
            } catch (error) {
                updateResult('numbering', 'fail', `Error verificando numeraci√≥n: ${error.message}`);
                log(`‚ùå Error en verificaci√≥n: ${error.message}`, 'error');
            }
        }
        
        async function verifyCounterLogic() {
            log('‚öôÔ∏è Verificando l√≥gica del contador de recibos...', 'info');
            
            try {
                // Test current date logic
                const today = new Date();
                const year = String(today.getFullYear());
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dayKey = `${year}${month}${day}`;
                
                log(`üìÖ Clave del d√≠a actual: ${dayKey}`, 'info');
                
                // Check daily counter
                const dailyCounter = localStorage.getItem(`receiptCounter_${dayKey}`);
                if (dailyCounter) {
                    log(`‚úÖ Contador diario encontrado: ${dailyCounter}`, 'success');
                } else {
                    log('‚ö†Ô∏è Contador diario no inicializado (normal para primer uso)', 'warning');
                }
                
                // Check global counter
                const globalCounter = localStorage.getItem('receiptCounter');
                if (globalCounter) {
                    log(`‚úÖ Contador global: ${globalCounter}`, 'success');
                } else {
                    log('‚ö†Ô∏è Contador global no encontrado', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Error verificando l√≥gica de contador: ${error.message}`, 'error');
            }
        }
        
        async function testSignatureSystem() {
            log('‚úçÔ∏è Verificando sistema de firmas digitales...', 'info');
            
            try {
                // Test 1: Check if SignaturePad library is loaded
                if (typeof window.SignaturePad !== 'undefined') {
                    log('‚úÖ Librer√≠a SignaturePad cargada', 'success');
                    
                    // Test 2: Check for signature functions
                    if (typeof window.initializeSignaturePad === 'function') {
                        updateResult('signature', 'pass', 'Sistema de firmas completamente funcional');
                        log('‚úÖ Funci√≥n de inicializaci√≥n de firmas disponible', 'success');
                    } else if (typeof window.signaturePad !== 'undefined') {
                        updateResult('signature', 'pass', 'SignaturePad inicializado y funcionando');
                        log('‚úÖ SignaturePad ya inicializado', 'success');
                    } else {
                        updateResult('signature', 'warning', 'Librer√≠a presente, inicializaci√≥n pendiente');
                        log('‚ö†Ô∏è SignaturePad no inicializado (normal en p√°gina principal)', 'warning');
                    }
                    
                } else {
                    updateResult('signature', 'fail', 'Librer√≠a SignaturePad no cargada - PROBLEMA CONFIRMADO');
                    log('‚ùå PROBLEMA CONFIRMADO: SignaturePad no disponible', 'error');
                }
                
            } catch (error) {
                updateResult('signature', 'fail', `Error verificando firmas: ${error.message}`);
                log(`‚ùå Error en verificaci√≥n de firmas: ${error.message}`, 'error');
            }
        }
        
        async function verifySignatureCanvas() {
            log('üé® Verificando elementos canvas para firmas...', 'info');
            
            const canvasIds = ['signatureCanvas', 'companySignatureCanvas'];
            let foundCanvas = 0;
            
            canvasIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    foundCanvas++;
                    log(`‚úÖ Canvas ${id} encontrado`, 'success');
                    
                    // Check canvas properties
                    if (canvas.width && canvas.height) {
                        log(`   ‚úì Dimensiones: ${canvas.width}x${canvas.height}`, 'info');
                    }
                } else {
                    log(`‚ùå Canvas ${id} no encontrado`, 'error');
                }
            });
            
            if (foundCanvas === 0) {
                log('‚ö†Ô∏è Ning√∫n canvas encontrado (normal en p√°gina principal)', 'warning');
            } else {
                log(`‚úÖ ${foundCanvas}/${canvasIds.length} canvas encontrados`, 'success');
            }
        }
        
        async function runAllVerifications() {
            log('üöÄ Iniciando verificaci√≥n completa de todas las quejas...', 'info');
            
            // Clear previous results
            verificationResults = {};
            
            try {
                await testPreviewFunction();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testPDFGeneration();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testReceiptNumbering();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testSignatureSystem();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                log('üìä Verificaci√≥n completa finalizada', 'info');
                generateComplaintsReport();
                
            } catch (error) {
                log(`‚ùå Error en verificaci√≥n completa: ${error.message}`, 'error');
            }
        }
        
        function generateComplaintsReport() {
            log('üìã Generando reporte de quejas del usuario...', 'info');
            
            const results = Object.values(verificationResults);
            const resolved = results.filter(r => r === 'pass').length;
            const partial = results.filter(r => r === 'warning').length;
            const failing = results.filter(r => r === 'fail').length;
            
            log('üìà REPORTE DE VERIFICACI√ìN DE QUEJAS:', 'info');
            log(`   ‚úÖ Completamente resueltos: ${resolved}/4`, resolved > 0 ? 'success' : 'error');
            log(`   ‚ö†Ô∏è Parcialmente resueltos: ${partial}/4`, partial > 0 ? 'warning' : 'info');
            log(`   ‚ùå Sin resolver: ${failing}/4`, failing > 0 ? 'error' : 'success');
            
            if (resolved === 4) {
                log('üéâ EXCELENTE: Todas las quejas han sido resueltas', 'success');
                log('üöÄ El sistema est√° completamente funcional seg√∫n expectativas', 'success');
            } else if (resolved + partial >= 3) {
                log('üëç BUENO: Mayor√≠a de problemas resueltos', 'success');
                log('üîß Solo requiere ajustes menores', 'warning');
            } else {
                log('‚ö†Ô∏è ATENCI√ìN: M√∫ltiples problemas identificados', 'warning');
                log('üõ†Ô∏è Se requieren reparaciones adicionales', 'error');
            }
        }
        
        function openReceiptPage() {
            log('üìÑ Abriendo p√°gina de recibos para verificaci√≥n manual...', 'info');
            window.open('receipt-mode.html', '_blank');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('ü©∫ Sistema de verificaci√≥n de quejas iniciado', 'success');
            log('üìã Listo para verificar los 4 problemas reportados por el usuario', 'info');
        });
    </script>
</body>
</html>