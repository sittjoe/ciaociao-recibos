<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recibo Premium | CiaoCiao.mx – Joyería Fina</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  
  <!-- jsPDF para generación de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    :root{
      --bg: #f8f7f3;           /* marfil suave */
      --paper: #fffdfa;        /* papel cálido */
      --ink: #1f2937;          /* gris carbón */
      --muted: #6b7280;        /* gris medio */
      --gold-1:#bfa36f;        /* oro satinado */
      --gold-2:#d9c08c;        /* oro claro */
      --gold-3:#a98e5b;        /* oro más profundo */
      --line:#e7e3d9;
      --error: #dc2626;
      --success: #16a34a;
    }

    @page{ size: Letter; margin: 18mm; }

    html, body { height: 100%; }
    body{
      margin:0; background: var(--bg); color: var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height:1.45;
    }

    /* CONTENEDOR CON MARCO PREMIUM */
    .sheet{
      max-width: 900px; margin: 40px auto; padding: 28px; position: relative;
      background: linear-gradient(#fffefa, #fffdf7);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.05);
    }
    .gilded-frame{
      position: relative; padding: 28px; border-radius: 14px;
      background:
        linear-gradient(var(--paper), var(--paper)) padding-box,
        linear-gradient(145deg, var(--gold-2), var(--gold-1), var(--gold-3)) border-box;
      border: 2px solid transparent;
    }

    /* CABECERA */
    .header{ display: grid; grid-template-columns: 160px 1fr 210px; gap: 20px; align-items: center; margin-bottom: 20px; }
    .brand{ display:flex; align-items:center; gap:14px; }
    .brand img{ width:160px; height:auto; display:block; filter: saturate(1.05) contrast(1.04); }
    .brand .brand-text{ font-family: "Playfair Display", serif; font-size: 14px; letter-spacing: .12em; color: var(--muted); text-transform: uppercase; }

    .doc-title{ text-align:center; }
    .doc-title h1{
      margin: 0; font-family: "Playfair Display", serif; font-size: 34px; letter-spacing: .06em;
      background: linear-gradient(120deg, var(--gold-1), var(--gold-2) 45%, var(--gold-3));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .doc-sub{ font-size:12px; color: var(--muted); letter-spacing:.16em; margin-top:6px; text-transform: uppercase; }

    .meta{ justify-self:end; border-left:1px solid var(--line); padding-left:16px; }
    .meta .row{ display:flex; justify-content: space-between; gap:16px; font-size:12px; color:var(--muted); margin-bottom: 4px; }
    .meta .value{ font-weight:600; color:var(--ink); }

    /* INFO PRINCIPAL */
    .section{ margin-top:26px; }
    .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .card{
      background: var(--paper); border:1px solid var(--line); border-radius:14px; padding:16px 18px;
    }
    .card h3{ margin:0 0 10px; font-family: "Playfair Display", serif; font-weight:700; font-size:16px; letter-spacing:.04em; }
    .field{ display:grid; grid-template-columns: 140px 1fr; gap:14px; padding:6px 0; border-bottom:1px dashed #eae6dc; }
    .field:last-child{ border-bottom:0; }
    .label{ color:var(--muted); font-size:12px; letter-spacing:.08em; text-transform: uppercase; }
    .value{ font-weight:600; }

    /* TABLA ÍTEMS */
    table{ width:100%; border-collapse: collapse; }
    .items{ overflow:hidden; border:1px solid var(--line); border-radius:14px; background: var(--paper); }
    .items thead th{
      font-size:12px; letter-spacing:.12em; color:var(--muted); text-transform: uppercase; text-align:left;
      background: linear-gradient(180deg, #fffdf6, #faf6eb); border-bottom:1px solid var(--line); padding:12px 14px;
    }
    .items tbody td{ padding:12px 14px; border-bottom:1px dashed #efe9dd; position: relative; }
    .items tbody tr:last-child td{ border-bottom:none; }
    .items tbody tr:hover{ background: rgba(217, 192, 140, 0.05); }
    .items tfoot td{ padding:12px 14px; }

    .right{ text-align:right; }
    .center{ text-align:center; }

    /* Botón eliminar fila */
    .delete-row {
      position: absolute;
      right: -25px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 1px solid var(--error);
      background: white;
      color: var(--error);
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      line-height: 1;
    }
    
    tr:hover .delete-row { display: flex; }

    .totals{ margin-top:14px; display:grid; grid-template-columns: 1fr 320px; gap:20px; align-items:start; }
    .note{ font-size:12px; color:var(--muted); }
    .sum-card{ background:var(--paper); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .sum-card .row{ display:grid; grid-template-columns: 1fr 140px; gap:10px; padding:10px 14px; border-bottom:1px dashed #efe9dd; }
    .sum-card .row:last-child{ border-bottom:none; }
    .sum-card .row.total{ background:linear-gradient(180deg,#fffdf6,#faf6eb); font-weight:700; font-size: 16px; }

    /* FIRMAS */
    .signatures{ margin-top:26px; display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
    .sig{ 
      height:140px; 
      border:1px dashed #d8cfbd; 
      border-radius:14px; 
      background: #fffef8; 
      position:relative; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .sig:hover { border-color: var(--gold-1); background: #fffdf3; }
    .sig canvas { 
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 8px;
    }
    .sig .label{ 
      position:absolute; 
      left:0; 
      right:0; 
      bottom:10px; 
      text-align:center; 
      font-size:12px; 
      color:var(--muted); 
      text-transform:uppercase; 
      letter-spacing:.12em; 
    }
    .sig .placeholder {
      color: var(--muted);
      font-size: 12px;
      opacity: 0.5;
      pointer-events: none;
    }
    .sig.signed .placeholder { display: none; }
    .sig .clear-sig {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 4px 8px;
      background: var(--error);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 10px;
      cursor: pointer;
      display: none;
    }
    .sig.signed .clear-sig { display: block; }

    /* BARRA ACCIONES */
    .actions{ display:flex; justify-content:space-between; gap:10px; margin-top:22px; flex-wrap: wrap; }
    .actions-left, .actions-right { display: flex; gap: 10px; }
    .btn{
      border:1px solid var(--gold-1); 
      color:#664f22; 
      background:linear-gradient(180deg, var(--gold-2), var(--gold-1));
      padding:10px 14px; 
      border-radius:12px; 
      font-weight:600; 
      letter-spacing:.04em; 
      cursor:pointer;
      box-shadow: 0 4px 10px rgba(191,163,111,.25);
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(191,163,111,.35); }
    .btn.secondary{ background:#fff; color:var(--ink); border:1px solid var(--line); box-shadow:none; }
    .btn.success{ background:linear-gradient(180deg, #22c55e, #16a34a); border-color: #16a34a; color: white; }
    .btn.danger{ background:linear-gradient(180deg, #ef4444, #dc2626); border-color: #dc2626; color: white; }

    /* FOOTER */
    footer{ margin-top:24px; text-align:center; font-size:12px; color:var(--muted); }
    footer .sep{ color:#d4c8ab; margin:0 8px; }

    /* WATERMARK LIGERA */
    .watermark{
      position:absolute; 
      inset:0; 
      pointer-events:none; 
      opacity:.03; 
      display:flex; 
      align-items:center; 
      justify-content:center;
      font-family:"Playfair Display", serif; 
      font-size:96px; 
      letter-spacing:.2em; 
      color:#8f7a4d;
      transform: rotate(-45deg);
    }

    /* EDITABLES */
    [contenteditable] { 
      outline: none; 
      min-height: 20px;
      transition: background 0.3s ease;
    }
    [contenteditable]:focus { 
      background: rgba(217, 192, 140, 0.1);
      border-radius: 4px;
      padding: 2px 4px;
      margin: -2px -4px;
    }
    .editable{ box-shadow: inset 0 -1px 0 #e8e0ce; }

    /* Modal de firma */
    .signature-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .signature-modal.active { display: flex; }
    .signature-modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .signature-modal h3 {
      margin: 0 0 16px 0;
      font-family: "Playfair Display", serif;
      font-size: 24px;
      color: var(--ink);
    }
    .signature-canvas-container {
      border: 2px solid var(--line);
      border-radius: 12px;
      margin: 16px 0;
      background: white;
    }
    .signature-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    /* Notificación */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.error { border-left: 4px solid var(--error); }
    .notification.show { display: flex; }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* PRINT */
    @media print{
      body{ background:#fff; }
      .sheet{ margin:0; box-shadow:none; padding: 0; }
      .actions, .watermark, .delete-row, .clear-sig { display:none !important; }
      [contenteditable] { background: transparent !important; padding: 0 !important; margin: 0 !important; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header { grid-template-columns: 1fr; text-align: center; gap: 16px; }
      .meta { border-left: none; border-top: 1px solid var(--line); padding: 16px 0 0 0; justify-self: center; }
      .two-col { grid-template-columns: 1fr; }
      .totals { grid-template-columns: 1fr; }
      .signatures { grid-template-columns: 1fr; }
      .actions { flex-direction: column; }
      .actions-left, .actions-right { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- Notification -->
  <div id="notification" class="notification">
    <span id="notification-message"></span>
  </div>

  <!-- Modal de firma -->
  <div id="signatureModal" class="signature-modal">
    <div class="signature-modal-content">
      <h3 id="signatureTitle">Firma</h3>
      <div class="signature-canvas-container">
        <canvas id="signatureCanvas" width="450" height="200"></canvas>
      </div>
      <div class="signature-modal-actions">
        <button class="btn secondary" onclick="clearModalSignature()">Limpiar</button>
        <button class="btn danger" onclick="closeSignatureModal()">Cancelar</button>
        <button class="btn success" onclick="saveSignature()">Guardar Firma</button>
      </div>
    </div>
  </div>

  <div class="sheet">
    <div class="watermark">CIAO CIAO MX</div>
    <div class="gilded-frame">
      <header class="header">
        <div class="brand">
          <img alt="CIAO CIAO MX – Joyería Fina" src="https://i.postimg.cc/FRC6PkXn/FINE-JEWELRY-85-x-54-mm-2000-x-1200-px.png"/>
        </div>
        <div class="doc-title">
          <h1>RECIBO</h1>
          <div class="doc-sub">Documento de entrega</div>
        </div>
        <div class="meta">
          <div class="row"><span>Folio</span><span class="value" id="receiptNumber">---</span></div>
          <div class="row"><span>Moneda</span><span class="value editable" contenteditable>MXN</span></div>
          <div class="row"><span>Método</span><span class="value editable" contenteditable>Efectivo</span></div>
        </div>
      </header>

      <section class="section two-col">
        <div class="card">
          <h3>Datos del Cliente</h3>
          <div class="field"><div class="label">Nombre</div><div class="value editable" contenteditable id="clientName">Nombre del Cliente</div></div>
          <div class="field"><div class="label">Teléfono</div><div class="value editable" contenteditable id="clientPhone">+52 1 55 0000 0000</div></div>
          <div class="field"><div class="label">Correo</div><div class="value editable" contenteditable id="clientEmail">cliente@email.com</div></div>
          <div class="field"><div class="label">Dirección</div><div class="value editable" contenteditable id="clientAddress">Dirección completa</div></div>
        </div>
        <div class="card">
          <h3>Fechas</h3>
          <div class="field"><div class="label">Fecha de emisión</div><div class="value" id="issueDate">---</div></div>
          <div class="field"><div class="label">Fecha de entrega</div><div class="value editable" contenteditable id="deliveryDate">---</div></div>
          <div class="field"><div class="label">Válido hasta</div><div class="value" id="validUntil">---</div></div>
        </div>
      </section>

      <section class="section">
        <div class="items">
          <table id="tabla-items">
            <thead>
              <tr>
                <th style="width:38%">Descripción</th>
                <th class="center" style="width:8%">Cant.</th>
                <th class="right" style="width:16%">Precio Unit.</th>
                <th class="right" style="width:16%">Importe</th>
                <th class="center" style="width:14%">SKU</th>
                <th style="width:8%"></th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <tr>
                <td class="editable" contenteditable>Artículo de joyería</td>
                <td class="center editable qty" contenteditable>1</td>
                <td class="right editable price" contenteditable>0.00</td>
                <td class="right subtotal">0.00</td>
                <td class="center editable" contenteditable>—</td>
                <td style="position:relative;">
                  <span class="delete-row" onclick="deleteRow(this)">×</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="totals">
          <div class="note">
            <p><strong>Observaciones</strong></p>
            <p class="editable" contenteditable id="observations">Joyas inspeccionadas y entregadas en perfecto estado. Se recomienda evitar contacto con químicos. Servicio de ajuste/limpieza disponible.</p>
            <p class="editable" contenteditable id="policy"><strong>Política:</strong> Garantía de por vida en mano de obra. Cambios sólo por defecto de fabricación dentro de 7 días.</p>
          </div>
          <div class="sum-card" id="totales">
            <div class="row"><div>Subtotal</div><div class="right" id="subtotal">0.00</div></div>
            <div class="row"><div>Descuento</div><div class="right editable" contenteditable id="descuento">0.00</div></div>
            <div class="row"><div>IVA (16%)</div><div class="right" id="iva">0.00</div></div>
            <div class="row total"><div>Total</div><div class="right" id="total">$0.00</div></div>
          </div>
        </div>
      </section>

      <section class="section signatures">
        <div class="sig" id="clientSignature" onclick="openSignatureModal('client')">
          <span class="placeholder">Click para firmar</span>
          <canvas id="clientSigCanvas" width="280" height="100" style="display:none;"></canvas>
          <button class="clear-sig" onclick="clearSignature(event, 'client')">Limpiar</button>
          <div class="label">Firma del cliente</div>
        </div>
        <div class="sig" id="companySignature" onclick="openSignatureModal('company')">
          <span class="placeholder">Click para firmar</span>
          <canvas id="companySigCanvas" width="280" height="100" style="display:none;"></canvas>
          <button class="clear-sig" onclick="clearSignature(event, 'company')">Limpiar</button>
          <div class="label">Firma del responsable</div>
        </div>
      </section>

      <section class="section two-col">
        <div class="card">
          <h3>Datos de la Joyería</h3>
          <div class="field"><div class="label">Nombre</div><div class="value">CIAO CIAO MX – Joyería Fina</div></div>
          <div class="field"><div class="label">Web</div><div class="value">www.ciaociao.mx</div></div>
          <div class="field"><div class="label">WhatsApp</div><div class="value">+52 1 55 9211 2643</div></div>
          <div class="field"><div class="label">Correo</div><div class="value">hola@ciaociao.mx</div></div>
        </div>
        <div class="card">
          <h3>Condiciones</h3>
          <div class="field"><div class="label">Garantía</div><div class="value">De por vida en mano de obra</div></div>
          <div class="field"><div class="label">Entrega</div><div class="value editable" contenteditable>En mano / Envío asegurado</div></div>
          <div class="field"><div class="label">Autenticidad</div><div class="value">Metales y gemas certificados</div></div>
        </div>
      </section>

      <div class="actions no-print">
        <div class="actions-left">
          <button class="btn secondary" id="add-row">➕ Agregar Producto</button>
          <button class="btn secondary" id="save-receipt">💾 Guardar</button>
          <button class="btn secondary" id="new-receipt">📄 Nuevo</button>
        </div>
        <div class="actions-right">
          <button class="btn success" onclick="generatePDF()">📥 Descargar PDF</button>
          <button class="btn" onclick="window.print()">🖨️ Imprimir</button>
        </div>
      </div>

      <footer>
        <span>© <span id="year"></span> CIAO CIAO MX</span><span class="sep">•</span>
        <span>Sistema Premium de Recibos</span><span class="sep">•</span>
        <span>Hecho con 💛 para la alta joyería</span>
      </footer>
    </div>
  </div>

  <script>
    // Utilidades
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

    // Variables globales
    let currentSignatureType = null;
    let signatureCanvas = null;
    let signatureCtx = null;
    let isDrawing = false;
    let signatures = {
      client: null,
      company: null
    };

    // Formateo de números
    function parseMoney(v) {
      if (!v) return 0;
      return parseFloat(String(v).replace(/[^0-9.\-]/g, '')) || 0;
    }

    function formato(n) {
      return new Intl.NumberFormat('es-MX', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
      }).format(n);
    }

    function formatoConSigno(n) {
      return '$' + formato(n);
    }

    // Generación automática de número de recibo
    function generateReceiptNumber() {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      // Obtener contador del día desde localStorage
      const dateKey = `CCI-${year}${month}${day}`;
      let dailyCounter = localStorage.getItem(dateKey) || '0';
      dailyCounter = parseInt(dailyCounter) + 1;
      
      // Guardar nuevo contador
      localStorage.setItem(dateKey, dailyCounter.toString());
      
      // Limpiar contadores antiguos (más de 30 días)
      cleanOldCounters();
      
      const receiptNumber = `CCI-${year}-${month}${day}-${String(dailyCounter).padStart(3, '0')}`;
      $('#receiptNumber').textContent = receiptNumber;
      
      return receiptNumber;
    }

    function cleanOldCounters() {
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('CCI-')) {
          const dateStr = key.split('-')[1];
          const keyDate = new Date(
            dateStr.substr(0, 4),
            parseInt(dateStr.substr(4, 2)) - 1,
            dateStr.substr(6, 2)
          );
          
          if (keyDate < thirtyDaysAgo) {
            localStorage.removeItem(key);
          }
        }
      });
    }

    // Fechas
    function formatDate(date) {
      const months = [
        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
      ];
      
      return `${date.getDate()} de ${months[date.getMonth()]} de ${date.getFullYear()}`;
    }

    function initializeDates() {
      const today = new Date();
      const validDate = new Date(today);
      validDate.setDate(validDate.getDate() + 30);
      
      $('#issueDate').textContent = formatDate(today);
      $('#deliveryDate').textContent = formatDate(today);
      $('#validUntil').textContent = formatDate(validDate);
    }

    // Cálculos
    function recalc() {
      let subtotal = 0;
      
      $$('#tabla-items tbody tr').forEach(tr => {
        const qty = parseMoney($('.qty', tr)?.textContent);
        const unit = parseMoney($('.price', tr)?.textContent);
        const imp = (qty * unit) || 0;
        $('.subtotal', tr).textContent = formato(imp);
        subtotal += imp;
      });
      
      $('#subtotal').textContent = formato(subtotal);
      
      const descuento = parseMoney($('#descuento')?.textContent);
      const base = Math.max(subtotal - descuento, 0);
      const iva = base * 0.16;
      
      $('#iva').textContent = formato(iva);
      $('#total').textContent = formatoConSigno(base + iva);
    }

    // Gestión de filas
    function addRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="editable" contenteditable>Artículo de joyería</td>
        <td class="center editable qty" contenteditable>1</td>
        <td class="right editable price" contenteditable>0.00</td>
        <td class="right subtotal">0.00</td>
        <td class="center editable" contenteditable>—</td>
        <td style="position:relative;">
          <span class="delete-row" onclick="deleteRow(this)">×</span>
        </td>
      `;
      $('#itemsBody').appendChild(tr);
      
      // Focus en el primer campo
      tr.querySelector('.editable').focus();
      
      showNotification('Producto agregado', 'success');
    }

    function deleteRow(btn) {
      const tr = btn.closest('tr');
      const tbody = tr.parentElement;
      
      // No eliminar si es la última fila
      if (tbody.children.length > 1) {
        tr.remove();
        recalc();
        showNotification('Producto eliminado', 'success');
      } else {
        showNotification('Debe mantener al menos un producto', 'error');
      }
    }

    // Sistema de firmas
    function initSignatureCanvas() {
      signatureCanvas = $('#signatureCanvas');
      signatureCtx = signatureCanvas.getContext('2d');
      
      signatureCtx.strokeStyle = '#1f2937';
      signatureCtx.lineWidth = 2;
      signatureCtx.lineCap = 'round';
      signatureCtx.lineJoin = 'round';
      
      // Mouse events
      signatureCanvas.addEventListener('mousedown', startDrawing);
      signatureCanvas.addEventListener('mousemove', draw);
      signatureCanvas.addEventListener('mouseup', stopDrawing);
      signatureCanvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events
      signatureCanvas.addEventListener('touchstart', handleTouch);
      signatureCanvas.addEventListener('touchmove', handleTouch);
      signatureCanvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e) {
      isDrawing = true;
      const rect = signatureCanvas.getBoundingClientRect();
      signatureCtx.beginPath();
      signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
      if (!isDrawing) return;
      
      const rect = signatureCanvas.getBoundingClientRect();
      signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      signatureCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                       e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      signatureCanvas.dispatchEvent(mouseEvent);
    }

    function openSignatureModal(type) {
      currentSignatureType = type;
      $('#signatureModal').classList.add('active');
      $('#signatureTitle').textContent = type === 'client' ? 'Firma del Cliente' : 'Firma del Responsable';
      
      // Limpiar canvas
      clearModalSignature();
      
      // Si ya hay firma, cargarla
      if (signatures[type]) {
        const img = new Image();
        img.onload = function() {
          signatureCtx.drawImage(img, 0, 0);
        };
        img.src = signatures[type];
      }
    }

    function closeSignatureModal() {
      $('#signatureModal').classList.remove('active');
      currentSignatureType = null;
    }

    function clearModalSignature() {
      if (signatureCtx) {
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
      }
    }

    function saveSignature() {
      if (signatureCanvas && currentSignatureType) {
        // Verificar si hay algo dibujado
        const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
        const pixels = imageData.data;
        let hasContent = false;
        
        for (let i = 0; i < pixels.length; i += 4) {
          if (pixels[i + 3] > 0) {
            hasContent = true;
            break;
          }
        }
        
        if (!hasContent) {
          showNotification('Por favor dibuje una firma', 'error');
          return;
        }
        
        // Guardar firma
        signatures[currentSignatureType] = signatureCanvas.toDataURL();
        
        // Mostrar en el recibo
        const targetCanvas = currentSignatureType === 'client' ? $('#clientSigCanvas') : $('#companySigCanvas');
        const targetCtx = targetCanvas.getContext('2d');
        targetCanvas.style.display = 'block';
        
        // Copiar firma al canvas pequeño
        targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
        targetCtx.drawImage(signatureCanvas, 0, 0, targetCanvas.width, targetCanvas.height);
        
        // Marcar como firmado
        const sigDiv = currentSignatureType === 'client' ? $('#clientSignature') : $('#companySignature');
        sigDiv.classList.add('signed');
        
        closeSignatureModal();
        showNotification('Firma guardada correctamente', 'success');
      }
    }

    function clearSignature(event, type) {
      event.stopPropagation();
      
      signatures[type] = null;
      
      const canvas = type === 'client' ? $('#clientSigCanvas') : $('#companySigCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      canvas.style.display = 'none';
      
      const sigDiv = type === 'client' ? $('#clientSignature') : $('#companySignature');
      sigDiv.classList.remove('signed');
      
      showNotification('Firma eliminada', 'success');
    }

    // Notificaciones
    function showNotification(message, type = 'success') {
      const notification = $('#notification');
      const messageEl = $('#notification-message');
      
      notification.className = `notification ${type} show`;
      messageEl.textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Guardar recibo
    function saveReceipt() {
      const receiptData = {
        number: $('#receiptNumber').textContent,
        date: new Date().toISOString(),
        client: {
          name: $('#clientName').textContent,
          phone: $('#clientPhone').textContent,
          email: $('#clientEmail').textContent,
          address: $('#clientAddress').textContent
        },
        items: [],
        totals: {
          subtotal: $('#subtotal').textContent,
          discount: $('#descuento').textContent,
          iva: $('#iva').textContent,
          total: $('#total').textContent
        },
        signatures: signatures,
        observations: $('#observations').textContent,
        policy: $('#policy').textContent
      };
      
      // Guardar items
      $$('#tabla-items tbody tr').forEach(tr => {
        const cells = $$('td', tr);
        receiptData.items.push({
          description: cells[0].textContent,
          qty: cells[1].textContent,
          price: cells[2].textContent,
          subtotal: cells[3].textContent,
          sku: cells[4].textContent
        });
      });
      
      // Guardar en localStorage
      const receipts = JSON.parse(localStorage.getItem('premium_receipts') || '[]');
      
      // Verificar si ya existe
      const existingIndex = receipts.findIndex(r => r.number === receiptData.number);
      if (existingIndex >= 0) {
        receipts[existingIndex] = receiptData;
      } else {
        receipts.push(receiptData);
      }
      
      localStorage.setItem('premium_receipts', JSON.stringify(receipts));
      showNotification('Recibo guardado correctamente', 'success');
    }

    // Nuevo recibo
    function newReceipt() {
      if (confirm('¿Crear un nuevo recibo? Los cambios no guardados se perderán.')) {
        // Limpiar formulario
        $('#clientName').textContent = 'Nombre del Cliente';
        $('#clientPhone').textContent = '+52 1 55 0000 0000';
        $('#clientEmail').textContent = 'cliente@email.com';
        $('#clientAddress').textContent = 'Dirección completa';
        
        // Limpiar tabla
        $('#itemsBody').innerHTML = `
          <tr>
            <td class="editable" contenteditable>Artículo de joyería</td>
            <td class="center editable qty" contenteditable>1</td>
            <td class="right editable price" contenteditable>0.00</td>
            <td class="right subtotal">0.00</td>
            <td class="center editable" contenteditable>—</td>
            <td style="position:relative;">
              <span class="delete-row" onclick="deleteRow(this)">×</span>
            </td>
          </tr>
        `;
        
        // Limpiar totales
        $('#descuento').textContent = '0.00';
        
        // Limpiar firmas
        signatures = { client: null, company: null };
        clearSignature(new Event('click'), 'client');
        clearSignature(new Event('click'), 'company');
        
        // Generar nuevo número
        generateReceiptNumber();
        initializeDates();
        recalc();
        
        showNotification('Nuevo recibo creado', 'success');
      }
    }

    // Generar PDF
    async function generatePDF() {
      try {
        showNotification('Generando PDF...', 'success');
        
        // Ocultar elementos no deseados
        $$('.delete-row, .clear-sig, .actions, .watermark').forEach(el => el.style.display = 'none');
        
        // Capturar el contenido
        const element = $('.gilded-frame');
        const canvas = await html2canvas(element, {
          scale: 2,
          logging: false,
          useCORS: true,
          backgroundColor: '#ffffff'
        });
        
        // Restaurar elementos
        $$('.delete-row, .clear-sig, .actions').forEach(el => el.style.display = '');
        $('.watermark').style.display = 'flex';
        
        // Crear PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'letter'
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        
        // Descargar
        const fileName = `Recibo_${$('#receiptNumber').textContent}_${$('#clientName').textContent.replace(/\s+/g, '_')}.pdf`;
        pdf.save(fileName);
        
        showNotification('PDF generado correctamente', 'success');
      } catch (error) {
        console.error('Error generando PDF:', error);
        showNotification('Error al generar PDF', 'error');
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar
      generateReceiptNumber();
      initializeDates();
      initSignatureCanvas();
      recalc();
      
      // Año actual
      $('#year').textContent = new Date().getFullYear();
      
      // Botones
      $('#add-row').addEventListener('click', addRow);
      $('#save-receipt').addEventListener('click', saveReceipt);
      $('#new-receipt').addEventListener('click', newReceipt);
      
      // Recalcular en cambios
      document.addEventListener('input', (e) => {
        if (e.target.matches('[contenteditable]')) {
          recalc();
        }
      });
      
      // Prevenir saltos de línea en campos editables
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target.matches('[contenteditable]')) {
          e.preventDefault();
          
          // Mover al siguiente campo editable
          const editables = $$('[contenteditable]');
          const currentIndex = editables.indexOf(e.target);
          if (currentIndex < editables.length - 1) {
            editables[currentIndex + 1].focus();
          }
        }
      });
      
      // Auto-guardar cada 30 segundos
      setInterval(() => {
        if ($('#receiptNumber').textContent !== '---') {
          saveReceipt();
        }
      }, 30000);
    });

    // Cerrar modal con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $('#signatureModal').classList.contains('active')) {
        closeSignatureModal();
      }
    });
  </script>
</body>
</html>