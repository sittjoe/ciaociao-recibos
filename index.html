<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Content Security Policy para bloquear extensiones maliciosas -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.metals.live https://api.kitco.com; object-src 'none'; frame-src 'none'; base-uri 'self'; form-action 'self';">
    <title>Sistema de Gesti√≥n - ciaociao.mx</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Google Fonts will be loaded via CDN Circuit Breaker -->
</head>
<body>
    <div class="mode-selector-container">
        <header class="selector-header">
            <img src="https://i.postimg.cc/FRC6PkXn/FINE-JEWELRY-85-x-54-mm-2000-x-1200-px.png" alt="ciaociao.mx" class="logo-main">
            <h1 class="selector-title">Sistema de Gesti√≥n</h1>
            <p class="selector-subtitle">¬øQu√© deseas hacer hoy?</p>
        </header>

        <div class="mode-cards">
            <div class="mode-card" onclick="selectMode('receipt')">
                <div class="mode-icon">üìÑ</div>
                <h2>RECIBOS</h2>
                <p class="mode-description">Generar recibos de venta, reparaci√≥n y apartados</p>
                <div class="mode-features">
                    <span>‚úì Pagos y abonos</span>
                    <span>‚úì Firma digital</span>
                    <span>‚úì WhatsApp integrado</span>
                </div>
                <div class="mode-stats" id="receiptStats">
                    <span class="stat-item">Total: <strong>0</strong></span>
                    <span class="stat-item">Hoy: <strong>0</strong></span>
                </div>
                <button class="mode-button">Ir a Recibos ‚Üí</button>
            </div>

            <div class="mode-card" onclick="selectMode('quotation')">
                <div class="mode-icon">üí∞</div>
                <h2>COTIZACIONES</h2>
                <p class="mode-description">Crear cotizaciones profesionales con m√∫ltiples productos</p>
                <div class="mode-features">
                    <span>‚úì M√∫ltiples productos</span>
                    <span>‚úì Descuentos autom√°ticos</span>
                    <span>‚úì Convertir a recibo</span>
                </div>
                <div class="mode-stats" id="quotationStats">
                    <span class="stat-item">Total: <strong>0</strong></span>
                    <span class="stat-item">Pendientes: <strong>0</strong></span>
                </div>
                <button class="mode-button">Ir a Cotizaciones ‚Üí</button>
            </div>

            <div class="mode-card" onclick="selectMode('calculator')">
                <div class="mode-icon">üîß</div>
                <h2>CALCULADORA</h2>
                <p class="mode-description">Calcular costos de fabricaci√≥n con precios actuales de mercado</p>
                <div class="mode-features">
                    <span>‚úì Precios en tiempo real</span>
                    <span>‚úì Metales y piedras</span>
                    <span>‚úì Exportar a cotizaci√≥n</span>
                </div>
                <div class="mode-stats" id="calculatorStats">
                    <span class="stat-item">Proyectos: <strong>0</strong></span>
                    <span class="stat-item">Guardados: <strong>0</strong></span>
                </div>
                <button class="mode-button">Ir a Calculadora ‚Üí</button>
            </div>
        </div>

        <div class="selector-footer">
            <button id="logoutBtnSelector" class="btn-logout-selector">üîí Cerrar Sesi√≥n</button>
            <p class="footer-info">¬© 2025 ciaociao.mx - Sistema de Gesti√≥n v3.0</p>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Browser Extension Filter - DEBE CARGARSE PRIMERO para interceptar errores -->
    <script src="browser-extension-filter.js"></script>
    <!-- Extension Detector - Detecta y analiza extensiones problem√°ticas -->
    <script src="extension-detector.js"></script>
    
    <!-- CDN Circuit Breaker System - Enterprise-grade CDN Management -->
    <script src="cdn-circuit-breaker.js"></script>
    <script src="cdn-health-monitor.js"></script>
    <script src="cdn-cache-manager.js"></script>
    
    <!-- Enhanced CDN Loading with Circuit Breaker -->
    <script>
        // Initialize CDN Circuit Breaker system
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Initializing CDN Circuit Breaker System...');
                
                // Wait for CDN Circuit Breaker to initialize
                let maxAttempts = 50; // 5 seconds max wait
                while (maxAttempts > 0 && (!window.cdnCircuitBreaker || !window.cdnCircuitBreaker.isInitialized)) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    maxAttempts--;
                }
                
                if (!window.cdnCircuitBreaker || !window.cdnCircuitBreaker.isInitialized) {
                    console.warn('‚ö†Ô∏è CDN Circuit Breaker not initialized, falling back to legacy loading');
                    loadDOMPurifyLegacy();
                    return;
                }
                
                // Load critical libraries through Circuit Breaker
                await loadLibrariesWithCircuitBreaker();
                
            } catch (error) {
                console.error('‚ùå CDN Circuit Breaker initialization failed:', error);
                loadDOMPurifyLegacy();
            }
        });
        
        // Enhanced library loading with Circuit Breaker
        async function loadLibrariesWithCircuitBreaker() {
            const libraries = ['domPurify', 'googleFonts'];
            const results = [];
            
            for (const library of libraries) {
                try {
                    console.log(`üì¶ Loading ${library} with Circuit Breaker...`);
                    const result = await window.cdnCircuitBreaker.loadLibrary(library);
                    results.push({ library, result });
                    
                    if (result.success) {
                        console.log(`‚úÖ ${library} loaded successfully from ${result.source}`);
                        
                        // Special handling for DOMPurify
                        if (library === 'domPurify' && typeof DOMPurify !== 'undefined') {
                            window.domPurifyLoaded = true;
                            console.log('üõ°Ô∏è DOMPurify ready for XSS protection');
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è ${library} loading failed:`, result.error || result.message);
                        
                        // Handle fallbacks
                        if (library === 'domPurify') {
                            console.log('üîÑ Enabling XSS protection fallback methods');
                            if (window.xssProtection) {
                                window.xssProtection.setupFallbackProtection();
                            }
                        }
                    }
                } catch (error) {
                    console.error(`‚ùå Failed to load ${library}:`, error);
                    results.push({ library, error: error.message });
                }
            }
            
            // Log loading summary
            console.log('üìä CDN Loading Summary:', results);
            
            // Display system status (for debugging)
            setTimeout(() => {
                displayCDNStatus();
            }, 2000);
        }
        
        // Legacy DOMPurify loading (fallback)
        function loadDOMPurifyLegacy() {
            console.log('üîÑ Using legacy DOMPurify loading...');
            
            const domPurifyUrls = [
                'https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js',
                'https://unpkg.com/dompurify@3.0.5/dist/purify.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js'
            ];
            
            function loadDOMPurifyScript(index = 0) {
                if (index >= domPurifyUrls.length) {
                    console.warn('‚ö†Ô∏è All DOMPurify CDNs failed, XSS protection will use fallback methods');
                    if (window.xssProtection) {
                        window.xssProtection.setupFallbackProtection();
                    }
                    return;
                }
                
                const script = document.createElement('script');
                script.src = domPurifyUrls[index];
                script.async = true;
                
                script.onload = function() {
                    window.domPurifyLoaded = true;
                    console.log(`‚úÖ DOMPurify loaded from: ${domPurifyUrls[index]}`);
                };
                
                script.onerror = function() {
                    console.warn(`‚ùå Failed to load DOMPurify from: ${domPurifyUrls[index]}`);
                    loadDOMPurifyScript(index + 1);
                };
                
                document.head.appendChild(script);
            }
            
            loadDOMPurifyScript();
        }
        
        // Display CDN system status (for debugging and monitoring)
        function displayCDNStatus() {
            if (!window.cdnCircuitBreaker) return;
            
            try {
                const status = window.cdnCircuitBreaker.getSystemStatus();
                console.group('üîç CDN Circuit Breaker Status');
                console.log('System Initialized:', status.isInitialized);
                console.log('Circuit Breakers:', status.circuitBreakers.length);
                console.log('Cache Size:', status.cache.size);
                console.log('Performance:', status.performance);
                
                // Log circuit breaker states
                status.circuitBreakers.forEach(cb => {
                    const stateEmoji = cb.state === 'CLOSED' ? '‚úÖ' : cb.state === 'OPEN' ? '‚ùå' : '‚ö†Ô∏è';
                    console.log(`${stateEmoji} ${cb.id}: ${cb.state} (Health: ${cb.isHealthy ? 'Good' : 'Poor'})`);
                });
                
                console.groupEnd();
                
                // Show health alerts if any
                if (window.cdnHealthMonitor) {
                    const alerts = window.cdnHealthMonitor.getActiveAlerts();
                    if (alerts.length > 0) {
                        console.warn('üö® Active CDN Health Alerts:', alerts.length);
                        alerts.forEach(alert => {
                            console.warn(`[${alert.severity}] ${alert.message}`);
                        });
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Failed to get CDN status:', error);
            }
        }
        
        // Expose CDN management functions globally
        window.CDNManager = {
            getStatus: () => {
                if (window.cdnCircuitBreaker) {
                    return window.cdnCircuitBreaker.getSystemStatus();
                }
                return { error: 'CDN Circuit Breaker not available' };
            },
            
            getHealthReport: () => {
                if (window.cdnHealthMonitor) {
                    return window.cdnHealthMonitor.getHealthStatus();
                }
                return { error: 'CDN Health Monitor not available' };
            },
            
            getCacheStats: () => {
                if (window.cdnCacheManager) {
                    return window.cdnCacheManager.getStats();
                }
                return { error: 'CDN Cache Manager not available' };
            },
            
            forceLibraryReload: async (libraryName) => {
                if (window.cdnCircuitBreaker) {
                    return await window.cdnCircuitBreaker.loadLibrary(libraryName, { maxAttempts: 10 });
                }
                return { error: 'CDN Circuit Breaker not available' };
            },
            
            clearCache: () => {
                if (window.cdnCacheManager) {
                    return window.cdnCacheManager.clear();
                }
                return { error: 'CDN Cache Manager not available' };
            },
            
            displayStatus: displayCDNStatus
        };
        
        // Add CDN status to SecurityManager if available
        if (window.securityManager) {
            setTimeout(() => {
                window.securityManager.getCDNCircuitBreakerStatus = () => {
                    return window.CDNManager.getStatus();
                };
            }, 3000);
        }
        
        console.log('üîß CDN Management functions exposed at window.CDNManager');
    </script>
    
    <!-- Core Security and Application Systems -->
    <!-- <script src="xss-protection.js"></script> TEMPORALMENTE DESHABILITADO - BLOQUEA PASSWORD INPUT -->
    <script src="security-manager.js"></script>
    <script src="auth.js"></script>
    <script src="database.js"></script>
    <script src="mode-selector.js"></script>
    
    <!-- Development Helper: CDN Status Monitor -->
    <script>
        // Add keyboard shortcut for CDN status (Ctrl+Shift+C)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                console.clear();
                console.log('%cüîç CDN CIRCUIT BREAKER SYSTEM STATUS', 'font-size: 16px; font-weight: bold; color: #00ff00;');
                window.CDNManager.displayStatus();
                
                // Also log security status
                if (window.securityManager && window.securityManager.getComprehensiveSecurityStatus) {
                    const securityStatus = window.securityManager.getComprehensiveSecurityStatus();
                    console.log('%cüîí COMPREHENSIVE SECURITY STATUS', 'font-size: 14px; font-weight: bold; color: #ff9000;');
                    console.log(securityStatus);
                }
                
                e.preventDefault();
            }
        });
        
        console.log('%cüîß Development Helper: Press Ctrl+Shift+C to view CDN status', 'color: #00aaff;');
    </script>
</body>
</html>